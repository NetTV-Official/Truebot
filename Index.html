<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ¤–</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Main Google Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif;
            background-color: #fff;
            color: #0d0d0d;
            display: flex;
            height: 100vh;
            transition: all 0.5s ease;
            -webkit-font-smoothing: antialiased;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        /* Allow text selection in message content */
        .message-content {
            -webkit-user-select: text;
            user-select: text;
        }

        /* Stranger Things theme - fonts and polished upside-down effect */
        @font-face {
            font-family: 'ITC Benguiat Bold';
            src: url('fonts/ITCBenguiatStdBoldCn.OTF') format('opentype');
            font-weight: 700;
            font-style: normal;
            font-display: swap;
        }

        @font-face {
            font-family: 'ITC Benguiat Medium';
            src: url('fonts/ITCBenguiatStdMediumCn.OTF') format('opentype');
            font-weight: 500;
            font-style: normal;
            font-display: swap;
        }

        /* Main site font (Google Sans Variable) */
        @font-face {
            font-family: 'Main Google Sans';
            src: url('fonts/MainFont/GoogleSans-VariableFont_GRAD,opsz,wght.ttf') format('truetype');
            font-weight: 100 900;
            font-style: normal;
            font-display: swap;
        }

        /* Title font */
        .empty-state-title,
        .timer-title {
            font-family: 'ITC Benguiat Bold', 'ITC Benguiat Medium', serif;
            letter-spacing: 0.6px;
            color: #0d0d0d;
        }

        /* Messages use the main Google Sans variable font for primary text */
        .message-content {
            font-family: 'Main Google Sans', 'ITC Benguiat Medium', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif;
        }

        /* Upside-down flip animation */
        .upside-flip {
            animation: stFlip 1.2s ease-in-out forwards;
            transform-origin: center;
        }

        @keyframes stFlip {
            0% { transform: rotateX(0deg); }
            45% { transform: rotateX(180deg); }
            55% { transform: rotateX(180deg); }
            100% { transform: rotateX(0deg); }
        }

        /* Persistent upside-down themed styling (red lighting, darker background) */
        body.upside-down-mode {
            background: radial-gradient(ellipse at center, #120000 0%, #000000 70%);
            color: #ffd6d6;
            transition: background 0.6s ease, color 0.6s ease, filter 0.6s ease;
        }

        body.upside-down-mode::before {
            content: '';
            position: fixed;
            inset: 0;
            pointer-events: none;
            background: radial-gradient(ellipse at top, rgba(255, 0, 0, 0.06), transparent 30%), linear-gradient(180deg, rgba(255,0,0,0.04), transparent 35%);
            mix-blend-mode: screen;
            z-index: 999;
        }

        body.upside-down-mode .sidebar {
            background: rgba(0,0,0,0.35);
            border-color: rgba(255,0,0,0.12);
            color: #ffd6d6;
        }

        body.upside-down-mode .new-chat-btn {
            background: rgba(255,255,255,0.02);
            border-color: rgba(255,0,0,0.12);
            color: #ffd6d6;
            box-shadow: 0 6px 20px rgba(255,0,0,0.04) inset;
        }

        body.upside-down-mode .message.user .message-content {
            background: linear-gradient(135deg,#4d0000,#7a0000);
            color: #ffecec;
            box-shadow: 0 6px 20px rgba(255,0,0,0.06);
        }

        body.upside-down-mode .message.assistant .message-content {
            background: rgba(0,0,0,0.5);
            color: #ffd6d6;
            border-left: 3px solid rgba(255,0,0,0.18);
        }

        /* Subtle scanline shimmer to add atmosphere when theme active */
        .upside-scanlines {
            position: fixed;
            inset: 0;
            pointer-events: none;
            background-image: linear-gradient(transparent 92%, rgba(255,0,0,0.02) 100%);
            background-size: 100% 8px;
            mix-blend-mode: overlay;
            opacity: 0;
            transition: opacity 0.4s ease;
            z-index: 998;
        }

        body.upside-down-mode .upside-scanlines { opacity: 1; }

        .sidebar {
            width: 260px;
            background-color: #fff;
            border-right: 1px solid #d1d5db;
            padding: 16px;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .new-chat-btn {
            width: 100%;
            padding: 10px 16px;
            background-color: #f7f7f8;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .new-chat-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(16, 163, 127, 0.1);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .new-chat-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .new-chat-btn:hover {
            background-color: #e5e5ea;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .new-chat-btn:active {
            transform: translateY(0);
        }

        .chat-history {
            margin-top: 20px;
        }

        .chat-item {
            padding: 12px;
            margin-bottom: 8px;
            background-color: transparent;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            color: #565869;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            transition: all 0.3s ease;
            transform: translateX(0);
        }

        .chat-item:hover {
            background-color: #f7f7f8;
            transform: translateX(4px);
            padding-left: 16px;
        }

        .main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #fff;
        }

        .chat-viewport {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            scroll-behavior: smooth;
        }

        .chat-viewport::-webkit-scrollbar {
            width: 8px;
        }

        .chat-viewport::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .chat-viewport::-webkit-scrollbar-thumb {
            background: #10a37f;
            border-radius: 10px;
            transition: background 0.3s;
        }

        .chat-viewport::-webkit-scrollbar-thumb:hover {
            background: #0d8a6b;
        }

        .message {
            display: flex;
            gap: 12px;
            max-width: 90%;
            word-wrap: break-word;
            animation: messageSlideIn 0.3s ease-out forwards;
            opacity: 1;
        }

        .message.user {
            align-self: flex-end;
            max-width: 90%;
            animation: messageSlideInRight 0.3s ease-out forwards;
        }

        .message.assistant {
            align-self: flex-start;
            max-width: 90%;
            animation: messageSlideInLeft 0.3s ease-out forwards;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes messageSlideInRight {
            from {
                opacity: 0;
                transform: translateX(20px) translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateX(0) translateY(0);
            }
        }

        @keyframes messageSlideInLeft {
            from {
                opacity: 0;
                transform: translateX(-20px) translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateX(0) translateY(0);
            }
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            color: white;
            flex-shrink: 0;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            animation: avatarPop 0.4s ease-out;
        }

        .message-avatar:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        @keyframes avatarPop {
            0% {
                transform: scale(0);
                opacity: 0;
            }
            50% {
                transform: scale(1.2);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .message-avatar.user {
            background-color: #10a37f;
        }

        .message-avatar.assistant {
            background-color: #e5e5ea;
            color: #0d0d0d;
        }

        .message-content {
            padding: 12px 16px;
            border-radius: 12px;
            line-height: 1.5;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .message.user .message-content {
            background-color: #10a37f;
            color: white;
            border-radius: 18px 4px 18px 18px;
        }

        .message.user .message-content:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(16, 163, 127, 0.3);
        }

        .message.assistant .message-content {
            background-color: #f7f7f8;
            color: #0d0d0d;
            border-radius: 4px 18px 18px 18px;
        }

        .message.assistant .message-content:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .chat-input-container {
            border-top: 1px solid #d1d5db;
            padding: 16px 20px;
            background-color: #fff;
        }

        .input-wrapper {
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }

        .file-upload-btn {
            padding: 10px 12px;
            background-color: #f0f0f0;
            border: 1px solid #d1d5db;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            color: #0d0d0d;
            font-size: 16px;
            min-width: 44px;
            min-height: 44px;
            -webkit-appearance: none;
            appearance: none;
        }

        .file-upload-btn:hover {
            background-color: #e5e5ea;
            border-color: #10a37f;
        }

        .file-upload-btn:active {
            transform: scale(0.95);
        }

        #fileInput {
            display: none;
        }

        .file-info {
            font-size: 12px;
            color: #565869;
            margin-top: 8px;
            padding: 8px;
            background-color: #f7f7f8;
            border-radius: 8px;
            border-left: 3px solid #10a37f;
        }

        .file-info-name {
            font-weight: 600;
            color: #0d0d0d;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 24px;
            font-size: 14px;
            font-family: inherit;
            resize: none;
            outline: none;
            transition: all 0.3s ease;
            max-height: none;
            min-height: 44px;
            -webkit-appearance: none;
            appearance: none;
        }

        .chat-input:focus {
            border-color: #10a37f;
            box-shadow: 0 0 0 3px rgba(16, 163, 127, 0.1);
            transform: translateY(-1px);
        }

        @supports (padding: max(0px)) {
            .chat-input {
                font-size: 16px;
            }
        }

        .send-btn {
            padding: 10px 12px;
            background-color: #10a37f;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            color: white;
            font-size: 16px;
            min-width: 44px;
            min-height: 44px;
            -webkit-appearance: none;
            appearance: none;
        }

        .send-btn:hover:not(:disabled) {
            opacity: 0.9;
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 4px 12px rgba(16, 163, 127, 0.4);
        }

        .send-btn:active:not(:disabled) {
            transform: scale(0.95);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #565869;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .empty-state-title {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #0d0d0d;
            animation: titleSlide 0.6s ease-out 0.2s both;
        }

        @keyframes titleSlide {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .empty-state-subtitle {
            font-size: 16px;
            color: #565869;
            animation: subtitleSlide 0.6s ease-out 0.4s both;
        }

        @keyframes subtitleSlide {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .loading-spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #10a37f;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
            align-items: center;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #10a37f;
            animation: typingDot 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes typingDot {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .code-block {
            background-color: #1e1e1e;
            color: #d4d4d4;
            border-radius: 8px;
            padding: 16px;
            margin: 8px 0;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            border-left: 4px solid #10a37f;
        }

        .code-language {
            color: #4ec9b0;
            font-size: 12px;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .code-content {
            white-space: pre-wrap;
            word-break: break-all;
        }

        .copy-btn {
            background-color: #10a37f;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }

        .copy-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(16, 163, 127, 0.3);
        }

        .copy-btn:active {
            transform: translateY(0);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .timer-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 24px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 24px;
            min-width: 320px;
            animation: timerPopupIn 0.4s ease-out;
        }

        @keyframes timerPopupIn {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        .timer-title {
            color: white;
            font-size: 24px;
            font-weight: 600;
            text-align: center;
        }

        .timer-clock {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            border: 4px solid rgba(255, 255, 255, 0.3);
        }

        .timer-clock-inner {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .timer-time {
            font-size: 48px;
            font-weight: bold;
            color: white;
            font-variant-numeric: tabular-nums;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .timer-label {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .timer-progress-ring {
            position: absolute;
            width: 200px;
            height: 200px;
            top: 0;
            left: 0;
        }

        .timer-progress-ring circle {
            fill: none;
            stroke: rgba(255, 255, 255, 0.5);
            stroke-width: 4;
            stroke-linecap: round;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            transition: stroke-dashoffset 0.1s linear;
        }

        .timer-controls {
            display: flex;
            gap: 12px;
        }

        .timer-btn {
            padding: 10px 24px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
        }

        .timer-btn-pause {
            background: rgba(255, 255, 255, 0.2);
        }

        .timer-btn-pause:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .timer-btn-stop {
            background: rgba(255, 77, 77, 0.8);
        }

        .timer-btn-stop:hover {
            background: rgba(255, 77, 77, 1);
            transform: translateY(-2px);
        }

        .timer-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1999;
            backdrop-filter: blur(4px);
        }

        /* Mobile Responsiveness */
        @media (max-width: 1024px) {
            .sidebar {
                width: 200px;
            }

            .chat-viewport {
                padding: 16px;
            }
        }

        @media (max-width: 768px) {
            body {
                flex-direction: column;
                height: auto;
                min-height: 100vh;
            }

            .sidebar {
                display: none;
            }

            .main-container {
                min-height: 100vh;
                display: flex;
                flex-direction: column;
            }

            .chat-viewport {
                flex: 1;
                padding: 12px 16px;
                gap: 12px;
            }

            .message {
                max-width: 95%;
                gap: 8px;
            }

            .message-avatar {
                width: 28px;
                height: 28px;
                font-size: 12px;
            }

            .message-content {
                padding: 10px 12px;
                font-size: 14px;
                border-radius: 10px;
            }

            .message.user .message-content {
                border-radius: 14px 2px 14px 14px;
            }

            .message.assistant .message-content {
                border-radius: 2px 14px 14px 14px;
            }

            .chat-input-container {
                padding: 12px 16px;
                border-top: 1px solid #d1d5db;
            }

            .input-wrapper {
                gap: 6px;
            }

            .file-upload-btn {
                padding: 8px 10px;
                font-size: 14px;
            }

            #messageInput {
                font-size: 16px;
                padding: 8px 12px !important;
                border-radius: 8px;
            }

            .send-btn {
                padding: 8px 10px;
                font-size: 14px;
            }

            .timer-popup {
                min-width: 280px;
                padding: 30px 20px;
                margin: 0 20px;
            }

            .timer-clock {
                width: 160px;
                height: 160px;
            }

            .timer-clock-inner {
                width: 140px;
                height: 140px;
            }

            .timer-time {
                font-size: 36px;
            }

            .timer-title {
                font-size: 20px;
                margin-bottom: 20px;
            }

            .empty-state-title {
                font-size: 24px;
            }

            .empty-state-subtitle {
                font-size: 14px;
            }
        }

        @media (max-width: 480px) {
            body {
                font-size: 13px;
            }

            .main-container {
                min-height: 100vh;
            }

            .chat-viewport {
                padding: 8px 12px;
                gap: 8px;
            }

            .message {
                max-width: 100%;
                gap: 6px;
                margin-right: 0;
                margin-left: 0;
            }

            .message.user {
                align-self: flex-end;
            }

            .message.assistant {
                align-self: flex-start;
            }

            .message-avatar {
                width: 24px;
                height: 24px;
                font-size: 10px;
            }

            .message-content {
                padding: 8px 10px;
                font-size: 13px;
                line-height: 1.4;
            }

            .chat-input-container {
                padding: 10px 12px;
                position: sticky;
                bottom: 0;
                background-color: #fff;
                z-index: 100;
            }

            .input-wrapper {
                gap: 4px;
                width: 100%;
            }

            #messageInput {
                font-size: 14px !important;
                padding: 6px 10px !important;
                border-radius: 6px;
            }

            .file-upload-btn {
                padding: 6px 8px;
                min-width: 36px;
                font-size: 12px;
            }

            .send-btn {
                padding: 6px 8px;
                min-width: 36px;
                font-size: 12px;
            }

            .timer-popup {
                min-width: 260px;
                padding: 20px 16px;
                margin: 0 10px;
                border-radius: 12px;
            }

            .timer-clock {
                width: 120px;
                height: 120px;
            }

            .timer-clock-inner {
                width: 110px;
                height: 110px;
            }

            .timer-time {
                font-size: 28px;
            }

            .timer-title {
                font-size: 18px;
                margin-bottom: 16px;
            }

            .empty-state-title {
                font-size: 20px;
            }

            .empty-state-subtitle {
                font-size: 12px;
            }

            .chat-item {
                font-size: 12px;
                padding: 8px;
            }

            .new-chat-btn {
                padding: 8px 12px;
                font-size: 12px;
            }
        }

        /* iPhone specific adjustments */
        @supports (padding: max(0px)) {
            @media (max-width: 480px) {
                body {
                    padding-left: max(0px, env(safe-area-inset-left));
                    padding-right: max(0px, env(safe-area-inset-right));
                    padding-top: max(0px, env(safe-area-inset-top));
                    padding-bottom: max(0px, env(safe-area-inset-bottom));
                }

                .chat-input-container {
                    padding-left: max(12px, env(safe-area-inset-left));
                    padding-right: max(12px, env(safe-area-inset-right));
                    padding-bottom: max(10px, env(safe-area-inset-bottom));
                }
            }
        }

        /* Processing Popup */
        .processing-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2001;
            backdrop-filter: blur(4px);
        }

        .processing-popup {
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
            animation: popupFadeIn 0.3s ease-out;
        }

        @keyframes popupFadeIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .processing-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #10a37f;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        .processing-text {
            font-size: 18px;
            color: #0d0d0d;
            font-weight: 600;
            margin: 0;
        }

        .processing-subtext {
            font-size: 14px;
            color: #565869;
            margin-top: 8px;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <button class="new-chat-btn" onclick="newChat()">+ New chat</button>
        <a href="Coding.html" style="display: block; padding: 12px 16px; color: #0d0d0d; text-decoration: none; border-radius: 8px; background-color: #f7f7f8; margin: 8px 12px; text-align: center; font-size: 14px; font-weight: 500; transition: all 0.3s ease; cursor: pointer;" onmouseover="this.style.backgroundColor='#efefef'" onmouseout="this.style.backgroundColor='#f7f7f8'">ðŸ’» Code & Dev</a>
        <div class="chat-history" id="chatHistory"></div>
    </div>

    <div class="main-container">
        <div class="chat-viewport" id="chatViewport">
            <div class="empty-state">
                <div class="empty-state-title">AI Chat</div>
                <div class="empty-state-subtitle">Start a conversation</div>
            </div>
        </div>

        <div class="chat-input-container">
            <div class="input-wrapper">
                <button class="file-upload-btn" id="uploadBtn" onclick="document.getElementById('fileInput').click()" title="Upload file">
                    ðŸ“Ž
                </button>
                <input 
                    type="text" 
                    class="chat-input" 
                    id="messageInput" 
                    placeholder="Send a message..."
                    onkeypress="handleKeyPress(event)"
                >
                <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                    âž¤
                </button>
            </div>
            <div id="fileInfoContainer"></div>
        </div>
        <input type="file" id="fileInput" onchange="handleFileUpload(event)">
    </div>

    <!-- Timer Popup -->
    <div class="timer-overlay" id="timerOverlay" style="display: none;"></div>
    <div class="timer-popup" id="timerPopup" style="display: none;">
        <div class="timer-title" id="timerTitle">Timer</div>
        <div class="timer-clock">
            <svg class="timer-progress-ring" id="timerProgressRing">
                <circle cx="100" cy="100" r="96" id="timerProgressCircle"></circle>
            </svg>
            <div class="timer-clock-inner">
                <div class="timer-time" id="timerTime">00:00</div>
                <div class="timer-label" id="timerLabel">Time Remaining</div>
            </div>
        </div>
        <div class="timer-controls">
            <button class="timer-btn timer-btn-pause" id="timerPauseBtn">Pause</button>
            <button class="timer-btn timer-btn-stop" id="timerStopBtn">Stop</button>
        </div>
    </div>


    <script>
        let config = {};
        let conversationHistory = [];
        let isLoading = false;
        let uploadedFileContent = null;
        let uploadedFileName = null;
        let uploadedFileType = null;

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            uploadedFileName = file.name;
            uploadedFileType = file.type;
            const fileSize = (file.size / 1024).toFixed(2); // Convert to KB
            
            try {
                // Read file content based on file type
                const fileType = file.type;
                
                if (fileType.startsWith('image/')) {
                    // For images, convert to base64
                    uploadedFileContent = await new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.readAsDataURL(file);
                    });
                } else if (fileType.startsWith('text/') || 
                    fileType === 'application/json' || 
                    fileType === 'application/javascript' ||
                    fileType === 'application/xml' ||
                    file.name.endsWith('.csv') ||
                    file.name.endsWith('.log') ||
                    file.name.endsWith('.md') ||
                    file.name.endsWith('.txt')) {
                    
                    uploadedFileContent = await file.text();
                } else {
                    // For other binary files, try to read as text, fallback to base64
                    uploadedFileContent = await new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = () => {
                            const fallback = new FileReader();
                            fallback.onload = () => resolve(fallback.result);
                            fallback.readAsDataURL(file);
                        };
                        reader.readAsText(file);
                    });
                }
                
                // Display file info
                displayFileInfo(uploadedFileName, fileSize, file.type);
                
                // Reset file input
                event.target.value = '';
                
            } catch (error) {
                console.error('Error reading file:', error);
                alert('Error reading file. Please try another file.');
                uploadedFileContent = null;
                uploadedFileName = null;
                uploadedFileType = null;
            }
        }

        // Display file information
        function displayFileInfo(fileName, fileSize, fileType) {
            const container = document.getElementById('fileInfoContainer');
            container.innerHTML = `
                <div class="file-info">
                    <span class="file-info-name">ðŸ“„ ${fileName}</span>
                    <span style="color: #565869;"> (${fileSize} KB) - Ready to analyze</span>
                </div>
            `;
        }

        // Clear uploaded file
        function clearUploadedFile() {
            uploadedFileContent = null;
            uploadedFileName = null;
            uploadedFileType = null;
            const container = document.getElementById('fileInfoContainer');
            container.innerHTML = '';
        }

        // Load configuration
        async function loadConfig() {
            try {
                const response = await fetch('https://api.jsonbin.io/v3/b/6946cf5fae596e708fa723d4');
                const data = await response.json();
                config = data.record;
                
                // Inject current date into system prompt
                const today = new Date();
                const formattedDate = today.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                config.SYSTEM_PROMPT = config.SYSTEM_PROMPT.replace('{CURRENT_DATE}', formattedDate);
                
                console.log('Config loaded:', { model: config.MODEL, date: formattedDate });
            } catch (error) {
                console.error('Failed to load config from JSONBin:', error);
                alert('Failed to load configuration. Please check JSONBin endpoint.');
            }
        }

        // New chat
        function newChat() {
            conversationHistory = [];
            const viewport = document.getElementById('chatViewport');
            viewport.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-title">AI Chat</div>
                    <div class="empty-state-subtitle">Start a conversation</div>
                </div>
            `;
            document.getElementById('messageInput').value = '';
        }

        // Handle key press
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Show processing popup
        function showProcessingPopup() {
            const overlay = document.createElement('div');
            overlay.className = 'processing-overlay';
            overlay.id = 'processingOverlay';
            overlay.innerHTML = `
                <div class="processing-popup">
                    <div class="processing-spinner"></div>
                    <p class="processing-text">This will take a while</p>
                    <p class="processing-subtext">Processing your request...</p>
                </div>
            `;
            document.body.appendChild(overlay);
        }

        // Hide processing popup
        function hideProcessingPopup() {
            const overlay = document.getElementById('processingOverlay');
            if (overlay) {
                overlay.remove();
            }
        }

        // Send message
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            // Allow sending if there's a message OR an uploaded file
            if ((!message && !uploadedFileContent) || isLoading) return;

            isLoading = true;
            document.getElementById('sendBtn').disabled = true;
            input.value = '';
            showProcessingPopup();

            // Special-case: trigger Stranger Things animation/theme when requested
            const stPatterns = [/stranger\s*things/i, /strangerthings/i, /upside\s*down/i];
            const stMatch = stPatterns.some(p => p.test(message));
            if (stMatch) {
                // Display user message
                displayMessage(message, 'user');

                // Remove empty state
                const emptyState = document.querySelector('.empty-state');
                if (emptyState) {
                    emptyState.remove();
                }

                // Add to history
                conversationHistory.push({ role: 'user', content: message });

                // Ensure scanlines element exists
                if (!document.querySelector('.upside-scanlines')) {
                    const scan = document.createElement('div');
                    scan.className = 'upside-scanlines';
                    document.body.appendChild(scan);
                }

                // Trigger theme animation
                triggerStrangerThingsTheme();

                isLoading = false;
                document.getElementById('sendBtn').disabled = false;
                document.getElementById('messageInput').focus();
                return;
            }

            // Check if user mentions "ChatGPT is better" - redirect to video
            const chatgptPatterns = [
                /chatgpt\s+is\s+better/i,
                /chat\s+gpt\s+is\s+better/i,
                /chatgpt's\s+better/i,
                /chat\s+gpt's\s+better/i
            ];
            
            let chatgptMatch = false;
            for (const pattern of chatgptPatterns) {
                if (pattern.test(message)) {
                    chatgptMatch = true;
                    break;
                }
            }
            
            if (chatgptMatch) {
                // Display user message
                displayMessage(message, 'user');
                
                // Remove empty state
                const emptyState = document.querySelector('.empty-state');
                if (emptyState) {
                    emptyState.remove();
                }
                
                // Add to history
                conversationHistory.push({ role: 'user', content: message });
                
                // Redirect to YouTube video
                window.location.href = 'https://youtu.be/rb8z2BMrd60?t=47';
                
                isLoading = false;
                document.getElementById('sendBtn').disabled = false;
                return;
            }

            // Check if user wants to set a timer
            const timerPatterns = [
                /set\s+(?:a\s+)?timer\s+(?:for\s+)?(\d+)\s*(minute|minutes|min|second|seconds|sec|hour|hours|hr|h)/i,
                /timer\s+(?:for\s+)?(\d+)\s*(minute|minutes|min|second|seconds|sec|hour|hours|hr|h)/i,
                /(\d+)\s*(minute|minutes|min|second|seconds|sec|hour|hours|hr|h)\s+timer/i
            ];
            
            let timerMatch = null;
            for (const pattern of timerPatterns) {
                timerMatch = message.match(pattern);
                if (timerMatch) break;
            }
            
            if (timerMatch) {
                const duration = parseInt(timerMatch[1]);
                const unit = timerMatch[2].toLowerCase();
                
                // Display user message
                displayMessage(message, 'user');
                
                // Remove empty state
                const emptyState = document.querySelector('.empty-state');
                if (emptyState) {
                    emptyState.remove();
                }
                
                // Add to history
                conversationHistory.push({ role: 'user', content: message });
                
                // Start timer
                startTimer(duration, unit);
                
                isLoading = false;
                document.getElementById('sendBtn').disabled = false;
                document.getElementById('messageInput').focus();
                return;
            }

            // Display user message
            displayMessage(message, 'user');

            // Remove empty state
            const emptyState = document.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }

            // Prepare message content with file if available
            let userMessage = { role: 'user' };
            
            if (uploadedFileContent && uploadedFileType && uploadedFileType.startsWith('image/')) {
                // For images, use vision/image format with base64
                const base64Data = uploadedFileContent.includes(',') 
                    ? uploadedFileContent.split(',')[1] 
                    : uploadedFileContent;
                
                userMessage.content = [
                    {
                        type: 'text',
                        text: message || 'Please analyze, translate, or describe this image.'
                    },
                    {
                        type: 'image',
                        source: {
                            type: 'base64',
                            media_type: uploadedFileType,
                            data: base64Data
                        }
                    }
                ];
            } else if (uploadedFileContent) {
                // For text files
                userMessage.content = message + `\n\n[File: ${uploadedFileName}]\n\`\`\`\n${uploadedFileContent}\n\`\`\``;
            } else {
                // Regular text message
                userMessage.content = message;
            }


            // Add to history
            conversationHistory.push(userMessage);

            // Show typing indicator immediately when waiting for AI response
            let typingIndicator = null;
            if (!document.querySelector('.typing-message')) {
                typingIndicator = showTypingIndicator();
            }

            try {
                // Check if user is asking for news
                const newsKeywords = ['news', 'latest', 'update', 'recent', 'bbc', 'headline', 'breaking'];
                const isNewsQuery = newsKeywords.some(keyword => message.toLowerCase().includes(keyword));
                
                let newsContext = '';
                if (isNewsQuery && config.NEWS_API_KEY && config.NEWS_API_KEY !== 'your_newsapi_key_here') {
                    newsContext = await fetchNews(message);
                }

                // Call API
                const messages = [
                    { role: 'system', content: config.SYSTEM_PROMPT },
                    ...conversationHistory
                ];

                // Add news context to the last user message if available
                if (newsContext && typeof messages[messages.length - 1].content === 'string') {
                    messages[messages.length - 1].content += `\n\n[Recent News Context]:\n${newsContext}`;
                }

                // Clear uploaded file after sending
                clearUploadedFile();

                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${config.API_KEY}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: config.MODEL,
                        messages: messages,
                    }),
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                const data = await response.json();
                const assistantMessage = data.choices[0].message.content;

                // Remove typing indicator before displaying message
                if (typingIndicator) {
                    removeTypingIndicator(typingIndicator);
                }

                hideProcessingPopup();

                // Ensure response includes code formatting
                let formattedResponse = assistantMessage;
                if (!formattedResponse.includes('```')) {
                    // If response doesn't have code blocks, add them if it looks like code
                    if (assistantMessage.includes('function') || assistantMessage.includes('const ') || assistantMessage.includes('class ') || assistantMessage.includes('{')) {
                        formattedResponse = '```\n' + assistantMessage + '\n```';
                    }
                }

                // Display assistant message (it will show its own typing indicator during typing animation)
                await displayMessage(formattedResponse, 'assistant');

                // Add to history
                conversationHistory.push({ role: 'assistant', content: assistantMessage });

            } catch (error) {
                console.error('Error:', error);
                hideProcessingPopup();
                // Remove typing indicator on error
                if (typingIndicator) {
                    removeTypingIndicator(typingIndicator);
                }
                await displayMessage('Sorry, an error occurred. Please try again.', 'assistant');
            } finally {
                isLoading = false;
                document.getElementById('sendBtn').disabled = false;
                document.getElementById('messageInput').focus();
            }
        }

        // Fetch news from NewsAPI
        async function fetchNews(query) {
            try {
                const searchTerm = query.toLowerCase().replace(/news|latest|update|recent|headline|breaking/gi, '').trim() || 'general';
                
                const response = await fetch(
                    `https://newsapi.org/v2/everything?q=${encodeURIComponent(searchTerm)}&sortBy=publishedAt&language=en&pageSize=5&apiKey=${config.NEWS_API_KEY}`
                );

                if (!response.ok) {
                    console.warn('News API error:', response.status);
                    return '';
                }

                const data = await response.json();
                
                if (!data.articles || data.articles.length === 0) {
                    return '';
                }

                // Format news articles
                let newsText = 'Recent News:\n';
                data.articles.forEach((article, index) => {
                    newsText += `\n${index + 1}. ${article.title}\n`;
                    newsText += `   Source: ${article.source.name} | Date: ${new Date(article.publishedAt).toLocaleDateString()}\n`;
                    newsText += `   ${article.description || article.content?.substring(0, 100) || ''}\n`;
                });

                return newsText;

            } catch (error) {
                console.error('Error fetching news:', error);
                return '';
            }
        }

        // Show typing indicator
        function showTypingIndicator() {
            const viewport = document.getElementById('chatViewport');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant typing-message';
            
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'message-avatar assistant';
            avatarDiv.textContent = 'AI';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'typing-indicator';
            for (let i = 0; i < 3; i++) {
                const dot = document.createElement('div');
                dot.className = 'typing-dot';
                typingIndicator.appendChild(dot);
            }
            
            contentDiv.appendChild(typingIndicator);
            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(contentDiv);
            
            viewport.appendChild(messageDiv);
            // Smooth scroll to bottom
            setTimeout(() => {
                viewport.scrollTo({
                    top: viewport.scrollHeight,
                    behavior: 'smooth'
                });
            }, 100);
            
            return messageDiv;
        }

        // Remove typing indicator
        function removeTypingIndicator(typingMessage) {
            if (typingMessage && typingMessage.parentNode) {
                typingMessage.remove();
            }
        }

        // Type text with animation (handles formatted text with **bold** and bold periods)
        async function typeFormattedText(container, text, speed = 15) {
            return new Promise((resolve) => {
                const formattedElements = parseFormattedText(text);
                let elementIndex = 0;
                let charIndex = 0;
                let currentElement = null;
                
                const typeChar = () => {
                    if (elementIndex < formattedElements.length) {
                        const element = formattedElements[elementIndex];
                        
                        // Initialize element if needed
                        if (!currentElement) {
                            if (element.type === 'bold') {
                                currentElement = document.createElement('strong');
                                container.appendChild(currentElement);
                            } else {
                                currentElement = container;
                            }
                        }
                        
                        if (charIndex < element.content.length) {
                            const char = element.content[charIndex];
                            
                            // Handle bold periods
                            if (char === '.' && element.type !== 'bold') {
                                const boldPeriod = document.createElement('strong');
                                boldPeriod.textContent = '.';
                                currentElement.appendChild(boldPeriod);
                                charIndex++;
                                setTimeout(typeChar, speed);
                            } else {
                                const textNode = document.createTextNode(char);
                                currentElement.appendChild(textNode);
                                charIndex++;
                                setTimeout(typeChar, speed);
                            }
                        } else {
                            // Move to next element
                            elementIndex++;
                            charIndex = 0;
                            currentElement = null;
                            setTimeout(typeChar, speed);
                        }
                    } else {
                        resolve();
                    }
                };
                typeChar();
            });
        }

        // Display message with typing animation for AI
        async function displayMessage(text, role) {
            const viewport = document.getElementById('chatViewport');
            
            // Show typing indicator for AI messages (only if not already showing)
            let typingMessage = null;
            if (role === 'assistant' && !document.querySelector('.typing-message')) {
                typingMessage = showTypingIndicator();
                // Brief pause to show typing indicator
                await new Promise(resolve => setTimeout(resolve, 300));
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            const avatarDiv = document.createElement('div');
            avatarDiv.className = `message-avatar ${role}`;
            avatarDiv.textContent = role === 'user' ? 'U' : 'AI';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            // Parse text for code blocks and regular text
            const codeBlockRegex = /```([^\n]*)?\n([\s\S]*?)```/g;
            let lastIndex = 0;
            let match;
            let hasCodeBlocks = false;
            const textParts = [];

            while ((match = codeBlockRegex.exec(text)) !== null) {
                hasCodeBlocks = true;
                // Add text before code block
                if (match.index > lastIndex) {
                    const textBefore = text.substring(lastIndex, match.index);
                    textParts.push({ type: 'text', content: textBefore });
                }

                // Add code block
                const language = match[1] || 'code';
                const code = match[2];
                textParts.push({ type: 'code', language: language, content: code });

                lastIndex = match.index + match[0].length;
            }

            // Add remaining text after code blocks
            if (hasCodeBlocks && lastIndex < text.length) {
                const textAfter = text.substring(lastIndex);
                textParts.push({ type: 'text', content: textAfter });
            }

            // If no code blocks, just add the entire text
            if (!hasCodeBlocks) {
                textParts.push({ type: 'text', content: text });
            }

            // For AI messages, type out the content
            if (role === 'assistant') {
                // Keep typing indicator visible while typing
                for (const part of textParts) {
                    if (part.type === 'text') {
                        const textSpan = document.createElement('span');
                        contentDiv.appendChild(textSpan);
                        await typeFormattedText(textSpan, part.content, 15);
                    } else if (part.type === 'code') {
                        // For code blocks, add them immediately (no typing)
                        addCodeBlock(contentDiv, part.content, part.language);
                    }
                }
                // Remove typing indicator only after all content is typed
                if (typingMessage) {
                    removeTypingIndicator(typingMessage);
                }
            } else {
                // For user messages, display immediately
                // Remove typing indicator if it exists (shouldn't happen for user messages, but just in case)
                if (typingMessage) {
                    removeTypingIndicator(typingMessage);
                }
                for (const part of textParts) {
                    if (part.type === 'text') {
                        addFormattedText(contentDiv, part.content);
                    } else if (part.type === 'code') {
                        addCodeBlock(contentDiv, part.content, part.language);
                    }
                }
            }

            if (role === 'user') {
                messageDiv.appendChild(contentDiv);
                messageDiv.appendChild(avatarDiv);
            } else {
                messageDiv.appendChild(avatarDiv);
                messageDiv.appendChild(contentDiv);
            }

            viewport.appendChild(messageDiv);
            // Smooth scroll to bottom
            setTimeout(() => {
                viewport.scrollTo({
                    top: viewport.scrollHeight,
                    behavior: 'smooth'
                });
            }, 100);
        }

        // Parse text with markdown-style bold (**text**) and bold periods
        function parseFormattedText(text) {
            const elements = [];
            // First, handle **bold** text
            const boldRegex = /\*\*(.+?)\*\*/g;
            let lastIndex = 0;
            let match;
            
            while ((match = boldRegex.exec(text)) !== null) {
                // Add text before bold
                if (match.index > lastIndex) {
                    const beforeText = text.substring(lastIndex, match.index);
                    if (beforeText) {
                        elements.push({ type: 'text', content: beforeText });
                    }
                }
                // Add bold text
                elements.push({ type: 'bold', content: match[1] });
                lastIndex = match.index + match[0].length;
            }
            
            // Add remaining text
            if (lastIndex < text.length) {
                const remainingText = text.substring(lastIndex);
                if (remainingText) {
                    elements.push({ type: 'text', content: remainingText });
                }
            }
            
            // If no bold text found, return the original text as a single element
            if (elements.length === 0) {
                elements.push({ type: 'text', content: text });
            }
            
            return elements;
        }

        // Add formatted text with bold periods and **bold** markdown
        function addFormattedText(container, text) {
            const span = document.createElement('span');
            const formattedElements = parseFormattedText(text);
            
            formattedElements.forEach(element => {
                if (element.type === 'bold') {
                    const boldElement = document.createElement('strong');
                    // Handle bold periods within bold text
                    const parts = element.content.split(/(\.)/);
                    parts.forEach(part => {
                        if (part === '.') {
                            const boldPeriod = document.createElement('strong');
                            boldPeriod.textContent = '.';
                            boldElement.appendChild(boldPeriod);
                        } else if (part) {
                            boldElement.appendChild(document.createTextNode(part));
                        }
                    });
                    span.appendChild(boldElement);
                } else {
                    // Handle regular text with bold periods
                    const parts = element.content.split(/(\.)/);
                    parts.forEach(part => {
                        if (part === '.') {
                            const boldPeriod = document.createElement('strong');
                            boldPeriod.textContent = '.';
                            span.appendChild(boldPeriod);
                        } else if (part) {
                            span.appendChild(document.createTextNode(part));
                        }
                    });
                }
            });
            
            container.appendChild(span);
        }

        // Add code block
        function addCodeBlock(container, code, language) {
            const codeDiv = document.createElement('div');
            codeDiv.className = 'code-block';

            if (language && language !== 'code') {
                const langSpan = document.createElement('div');
                langSpan.className = 'code-language';
                langSpan.textContent = language;
                codeDiv.appendChild(langSpan);
            }

            const copyBtn = document.createElement('button');
            copyBtn.className = 'copy-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.onclick = () => {
                navigator.clipboard.writeText(code);
                copyBtn.textContent = 'Copied!';
                setTimeout(() => {
                    copyBtn.textContent = 'Copy';
                }, 2000);
            };
            codeDiv.appendChild(copyBtn);

            const codeContent = document.createElement('pre');
            codeContent.className = 'code-content';
            codeContent.textContent = code.trim();
            codeDiv.appendChild(codeContent);

            container.appendChild(codeDiv);
        }

        // Timer functionality
        let timerInterval = null;
        let timerSeconds = 0;
        let timerTotalSeconds = 0;
        let timerPaused = false;

        // Request notification permission
        async function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                await Notification.requestPermission();
            }
        }

        // Show notification
        function showTimerNotification() {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('Timer Complete!', {
                    body: 'Your timer has finished.',
                    icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">â°</text></svg>',
                    tag: 'timer-notification'
                });
            }
        }

        // Format time display
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        // Update timer display
        function updateTimerDisplay() {
            const timeElement = document.getElementById('timerTime');
            const progressCircle = document.getElementById('timerProgressCircle');
            
            if (timeElement) {
                timeElement.textContent = formatTime(timerSeconds);
            }
            
            if (progressCircle && timerTotalSeconds > 0) {
                const circumference = 2 * Math.PI * 96;
                const progress = (timerTotalSeconds - timerSeconds) / timerTotalSeconds;
                const offset = circumference - (progress * circumference);
                progressCircle.style.strokeDasharray = `${circumference} ${circumference}`;
                progressCircle.style.strokeDashoffset = offset;
            }
        }

        // Start timer
        function startTimer(duration, unit) {
            // Request notification permission
            requestNotificationPermission();
            
            // Convert to seconds
            let totalSeconds = duration;
            if (unit.includes('min')) {
                totalSeconds = duration * 60;
            } else if (unit.includes('hour') || unit.includes('hr')) {
                totalSeconds = duration * 3600;
            }
            
            timerSeconds = totalSeconds;
            timerTotalSeconds = totalSeconds;
            timerPaused = false;
            
            // Show timer popup
            const popup = document.getElementById('timerPopup');
            const overlay = document.getElementById('timerOverlay');
            popup.style.display = 'flex';
            overlay.style.display = 'block';
            
            // Update title
            const title = document.getElementById('timerTitle');
            title.textContent = `Timer: ${duration} ${unit}`;
            
            // Setup progress circle
            const progressCircle = document.getElementById('timerProgressCircle');
            const circumference = 2 * Math.PI * 96;
            progressCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            progressCircle.style.strokeDashoffset = circumference;
            
            // Update display
            updateTimerDisplay();
            
            // Start countdown
            timerInterval = setInterval(() => {
                if (!timerPaused && timerSeconds > 0) {
                    timerSeconds--;
                    updateTimerDisplay();
                    
                    if (timerSeconds === 0) {
                        clearInterval(timerInterval);
                        timerInterval = null;
                        
                        // Show notification
                        showTimerNotification();
                        
                        // Play sound (if available)
                        try {
                            const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjGH0fPTgjMGHm7A7+OZUg4PUa3l77BdGAg+ltryzXkpBSV+zfLZiTYIGWi77+efTRAMUKfj8LZjHAY4kdfyzHksBSR3x/DdkEAKFF606euoVRQKRp/g8r5sIQYxh9Hz04IzBh5uwO/jmVIOD1Gt5e+wXRgIPpba8s15KQUlfs3y2Yk2CBlou+/nn00QDFCn4/C2YxwGOJHX8sx5LAUkd8fw3ZBAC');
                            audio.play().catch(() => {});
                        } catch (e) {}
                        
                        // Update title
                        title.textContent = 'Timer Complete!';
                        
                        // Change button text
                        const pauseBtn = document.getElementById('timerPauseBtn');
                        pauseBtn.textContent = 'Restart';
                        pauseBtn.onclick = () => {
                            startTimer(duration, unit);
                        };
                    }
                }
            }, 1000);
        }

        // Stop timer
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            const popup = document.getElementById('timerPopup');
            const overlay = document.getElementById('timerOverlay');
            popup.style.display = 'none';
            overlay.style.display = 'none';
            
            timerSeconds = 0;
            timerTotalSeconds = 0;
            timerPaused = false;
        }

        // Pause/Resume timer
        function toggleTimerPause() {
            timerPaused = !timerPaused;
            const pauseBtn = document.getElementById('timerPauseBtn');
            pauseBtn.textContent = timerPaused ? 'Resume' : 'Pause';
        }

        // Setup timer controls
        document.addEventListener('DOMContentLoaded', () => {
            const pauseBtn = document.getElementById('timerPauseBtn');
            const stopBtn = document.getElementById('timerStopBtn');
            
            if (pauseBtn) {
                pauseBtn.addEventListener('click', toggleTimerPause);
            }
            
            if (stopBtn) {
                stopBtn.addEventListener('click', stopTimer);
            }
        });

        // Stranger Things theme activation: flip animation, red lighting, and title flicker
        function triggerStrangerThingsTheme() {
            const originalTitle = document.title;
            const html = document.documentElement;
            const body = document.body;

            const flipDuration = 1200; // matches CSS animation length
            const holdDuration = 2400; // time to keep atmosphere after flip
            const totalFlicker = flipDuration + holdDuration + 800;

            // Start title flicker
            startTitleFlicker(totalFlicker, originalTitle);

            // Add a flip animation class to the root to animate the page
            html.classList.add('upside-flip');

            // While flipped (mid-animation) enable upside-down visual theme
            setTimeout(() => {
                body.classList.add('upside-down-mode');
            }, Math.floor(flipDuration / 2));

            // After flip animation finishes, remove the flip class so the page returns
            setTimeout(() => {
                html.classList.remove('upside-flip');
                // keep the upside-down-mode active to preserve the red lighting/theme
            }, flipDuration);

            // Optionally do a small pulse of scanlines for atmosphere
            const scan = document.querySelector('.upside-scanlines');
            if (scan) {
                scan.style.opacity = '0';
                // brief pulse in
                setTimeout(() => { scan.style.opacity = '0.18'; }, flipDuration - 200);
                // then settle to CSS-driven opacity
                setTimeout(() => { scan.style.opacity = ''; }, flipDuration + 800);
            }

            // After total flicker period, restore title (handled by startTitleFlicker) and focus input
            setTimeout(() => {
                const input = document.getElementById('messageInput');
                if (input) input.focus();
            }, totalFlicker + 100);
        }

        function startTitleFlicker(duration = 3000, originalTitle = document.title) {
            let elapsed = 0;
            const minInterval = 80;
            const maxInterval = 220;

            const flicker = () => {
                const next = Math.floor(Math.random() * (maxInterval - minInterval)) + minInterval;
                // random flicker text choices for effect
                const altTitles = ['S T R A N G E R  T H I N G S', 'UPSIDE DOWN', '...'];
                document.title = Math.random() > 0.5 ? altTitles[Math.floor(Math.random() * altTitles.length)] : originalTitle;
                elapsed += next;
                if (elapsed < duration) {
                    setTimeout(flicker, next);
                } else {
                    document.title = originalTitle;
                }
            };

            flicker();
        }

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            loadConfig();
            document.getElementById('messageInput').focus();
            requestNotificationPermission();
        });
    </script>
</body>
</html>

